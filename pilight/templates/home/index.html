{% extends 'base.html' %}
{% load pilight_extras %}
{% load static from staticfiles %}

{% block head %}
    <link href="{% static "css/slider.css" %}" rel="stylesheet" type="text/css" />
    <link href="{% static "css/bootstrap-colorpicker.min.css" %}" rel="stylesheet" type="text/css" />
{% endblock %}

{% block body %}
    <div class="row">
        <div class="col-md-8">
            <h1>{{ INSTALLATION_NAME }}</h1>
        </div>
        <div class="col-md-4">
            <div class="row">
                <div class="col-md-12 header-buttons">
                    <div class="btn-group">
                        <button class="btn btn-success" id="btn-start">Start</button>
                        <button class="btn btn-danger" id="btn-stop">Stop</button>
                        <button class="btn btn-primary" id="btn-refresh">Refresh</button>
                    </div>
                    &nbsp;
                    <button class="btn btn-info" id="btn-simulate">Preview</button>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 header-buttons" style="width: 302px">
                    <div class="input-group">
                        <input class="form-control input-sm" type="text" id="store-name" placeholder="Save as..." />
                        <div class="input-group-btn btn-group-sm">
                            <button class="btn btn-success" id="btn-save">Save</button>
                            <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown" id="btn-load">Load <span class="caret"></span></button>
                            <ul class="dropdown-menu" role="menu" id="store-list-content">
                                {% include 'home/snippets/stores-list.html' %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <section id="current-lights">
        <div class="row">
            <div class="col-md-12">
                <h3>Default Colors</h3>
                <p class="hidden-xs"><small>Specify what base colors are applied to each LED, prior to transforms taking effect. Use the Solid/Smooth tool and pick a color, then click on an LED.</small></p>
            </div>
        </div>
        <div class="row pad-bottom">
            <div class="col-md-12">
                <div class="row pad-bottom">
                    <div class="col-md-8">
                        <div class="btn-group" data-toggle="buttons">
                            <label class="btn btn-default">
                                <input type="radio" name="tool" id="tool-solid" value="solid"> Solid
                            </label>
                            <label class="btn btn-default active">
                                <input type="radio" name="tool" id="tool-smooth" value="smooth" checked> Smooth
                            </label>
                        </div>
                        &nbsp;&nbsp;
                        <label>
                            Radius
                            <input type="text" id="slider-radius" name="slider-radius" class="form-control slider-control" value="5" data-slider-min="0" data-slider-max="30" data-slider-step="1" data-slider-value="5">
                        </label>
                        &nbsp;&nbsp;
                        <label>
                            Opacity
                            <input type="text" id="slider-opacity" name="slider-opacity" class="form-control slider-control" value="100" data-slider-min="1" data-slider-max="100" data-slider-step="1" data-slider-value="100">
                        </label>
                    </div>
                    <div class="col-md-2">
                        <div class="input-group colorpicker-component" id="color-control" data-color="{{ tool_color }}" style="width: 130px;">
                            <input type="text" class="form-control" value="{{ tool_color }}" readonly id="color-value" />
                            <span class="input-group-addon"><i style="background-color: {{ tool_color }}"></i></span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-default" id="btn-fill">Fill</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12" id="current-lights-content">
                    {% include "home/snippets/lights.html" %}
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section id="available-transforms">
        <div class="row">
            <div class="col-md-12">
                <h3>Available Transforms</h3>
                <p class="hidden-xs"><small>All the available types of transforms that can be applied. Activate one by clicking Add.</small></p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-10">
                <table class="table table-hover table-condensed table-bordered">
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th></th>
                    </tr>
                    {% for transform in transforms %}
                        <tr>
                            <td>{{ transform.long_name }}</td>
                            <td>{{ transform.description }}</td>
                            <td><button class="btn btn-xs btn-primary btn-transform-add" id="transform-add-{{ transform.id }}">Add</button></td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </section>
    <section id="current-transforms">
        <div class="row">
            <div class="col-md-12">
                <h3>Active Transforms</h3>
                <p class="hidden-xs"><small>All currently active transforms. Set parameters for each transform and specify which order they should run in.</small></p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-10" id="current-transforms-content">
                {% include "home/snippets/transforms.html" %}
            </div>
            <div class="col-md-2">

            </div>
        </div>
    </section>
{% endblock %}

{% block js %}
    <script src="{% static "js/modernizr-touch.js" %}"></script>
    <script src="{% static "js/bootstrap-slider.js" %}"></script>
    <script src="{% static "js/bootstrap-colorpicker.min.js" %}"></script>
    <script type="text/javascript">
        // Array Remove - By John Resig (MIT Licensed)
        Array.prototype.remove = function(from, to) {
            var rest = this.slice((to || from) + 1 || this.length);
            this.length = from < 0 ? this.length + from : from;
            return this.push.apply(this, rest);
        };

        function refreshLights() {
            $.post("{% url 'home.views.render_lights_snippet' %}", null, function(data) {
                $("div#current-lights-content").html(data);
                bindLights();
            }, "html");
        }

        function refreshTransforms() {
            $.post("{% url 'home.views.render_transforms_snippet' %}", null, function(data) {
                $("div#current-transforms-content").html(data);
                bindTransforms();
            }, "html");
        }

        function refreshStores() {
            $.post("{% url 'home.views.render_stores_snippet' %}", null, function(data) {
                $("ul#store-list-content").html(data);
                bindStores();
            }, "html");
        }

        function restartDriver() {
            $.post("{% url 'home.views.restart_driver' %}");
        }

        function bindLights() {
            $('button.btn-light').click(function(){
                // Run the selected tool on the clicked light
                var tool = $("input:radio[name=tool]:checked").val();
                if (!tool) {
                    // We don't actually have a tool
                    return;
                }
                var index = parseInt(this.id.substr(6));
                if (isNaN(index)) {
                    // Invalid index
                    return;
                }
                var radius = parseInt($('input#slider-radius').val());
                var opacity = parseInt($('input#slider-opacity').val());
                if (isNaN(radius) || isNaN(opacity)) {
                    // Invalid tool params
                    return;
                }
                var color = $('input#color-value').val();

                var post_data = {index:index, radius:radius, opacity:opacity, tool:tool, color:color};
                $.post("{% url 'home.views.apply_light_tool' %}", post_data, function(data) {
                    if (data.success) {
                        // Success - refresh lights
                        refreshLights();
                    }
                }, "json");
            });
        }

        function bindTransforms() {
            $('button.btn-transform-save').click(function() {
                // Post back the params
                var index = parseInt(this.id.substr(15))
                if (isNaN(index)) {
                    return;
                }
                var params = $('input#transform-params-'+index).val();

                var post_data = {transform_id:index,params:params};
                $.post("{% url 'home.views.update_transform_params' %}", post_data, function(data) {
                    if (data.success) {
                        refreshTransforms();
                    }
                }, "json");
            });
            $('button.btn-transform-delete').click(function() {
                // Delete the transform
                var index = parseInt(this.id.substr(17))
                if (isNaN(index)) {
                    return;
                }

                var post_data = {transform_id:index};
                $.post("{% url 'home.views.delete_transform' %}", post_data, function(data) {
                    if (data.success) {
                        refreshTransforms();
                    }
                }, "json");
            });
        }

        function bindStores() {
            $('a.store-load').click(function() {
                // Load the given store
                var index = parseInt(this.id.substr(11));
                if (isNaN(index)) {
                    return;
                }

                var store_name = $(this).html();

                // Disable the load button temporarily
                $('button#btn-load').prop('disabled', true);

                var post_data = {store_id:index};
                $.post("{% url 'home.views.load_store' %}", post_data, function(data) {
                    if (data.success) {
                        $('input#store-name').val(store_name);
                        refreshLights();
                        refreshTransforms();
                        $('button#btn-load').prop('disabled', false);
                    }
                }, "json");
            });
        }

        var simData = null;

        function startSimulation(data) {
            if (data.length < 2) {
                // Don't bother trying to run this animation
                return;
            }

            // Disable all light buttons and refresh button
            $('button.btn-light').unbind('click');
            $('button#btn-simulate').prop('disabled', true);

            // Set the data and start the animation
            simData = data;
            window.setTimeout(doSimulation, 100);
        }

        function doSimulation() {
            // Has this animation finished?
            if (simData == null || simData.length <= 0) {
                simData = null;
                $('button#btn-simulate').prop('disabled', false);
                refreshLights();
                return;
            }

            // Basically just pop the first item from data, and
            // apply it to our light buttons
            var currentColors = simData[0];
            for (var i = 0; i < currentColors.length; i++) {
                $('button#light-'+i).css('background-color', currentColors[i]);
            }

            // Remove the current color set
            simData.remove(0);

            // Queue up the next step
            window.setTimeout(doSimulation, 100);
        }

        // using jQuery
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            crossDomain: false, // obviates need for sameOrigin test
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type)) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        $(document).ready(function() {
            $('input.slider-control').slider();
            $('#color-control').colorpicker();
            $('button#btn-refresh').click(function() {
                restartDriver();
                refreshLights();
                refreshTransforms();
            });
            $('button#btn-start').click(function() {
                $.post("{% url 'home.views.start_driver' %}");
            });
            $('button#btn-stop').click(function() {
                $.post("{% url 'home.views.stop_driver' %}");
            });
            $('button#btn-simulate').click(function() {
                $.post("{% url 'home.views.run_simulation' %}", null, function(data) {
                    startSimulation(data);
                }, "json");
            });
            $('button.btn-transform-add').click(function() {
                // Add a new transform
                var index = parseInt(this.id.substr(14));
                if (isNaN(index)) {
                    return;
                }

                var post_data = {transform_id:index};
                $.post("{% url 'home.views.add_transform' %}", post_data, function(data) {
                    if (data.success) {
                        refreshTransforms();
                    }
                }, "json");
            });
            $('button#btn-fill').click(function() {
                var color = $('input#color-value').val();

                var post_data = {color:color};
                $.post("{% url 'home.views.fill_color' %}", post_data, function(data) {
                    if (data.success) {
                        // Success - refresh lights
                        refreshLights();
                    }
                }, "json");
            });
            $('button#btn-save').click(function() {
                var store_name = $('input#store-name').val();
                if (!store_name || store_name.length === 0) {
                    return;
                }
                // Disable the button while we save
                $('button#btn-save').prop('disabled', true);

                var post_data = {store_name:store_name};
                $.post("{% url 'home.views.save_store' %}", post_data, function(data) {
                    if (data.success) {
                        refreshStores();
                        $('button#btn-save').prop('disabled', false);
                    }
                }, "json");
            });
            bindLights();
            bindTransforms();
            bindStores();
        });
    </script>
{% endblock %}